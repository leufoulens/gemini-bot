import TelegramBot from 'node-telegram-bot-api';
import { GoogleGenAI } from '@google/genai';
import dotenv from 'dotenv';
import fs from 'fs';
import path from 'path';
import axios from 'axios';

dotenv.config();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gemini AI
const ai = new GoogleGenAI({
  apiKey: process.env.GEMINI_API_KEY
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –±–æ—Ç–∞
const bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: true });

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
const userSessions = new Map();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Ç-—Å–µ—Å—Å–∏–π —Å Gemini
const chatSessions = new Map();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –º—É–ª—å—Ç–∏–æ–±—Ä–∞–∑–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const imageStorage = new Map();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const chatConfigs = new Map();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const imageModels = new Map();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
const videoModels = new Map();

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
const regeneratePrompts = new Map();

console.log('ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
function showMainMenu(chatId) {
  const keyboard = {
    keyboard: [
      [{ text: 'üí¨ –ß–∞—Ç —Å Gemini' }],
      [{ text: 'üîç –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' }, { text: 'üé® –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' }],
      [{ text: 'üñºÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π' }, { text: 'üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ' }],
      [{ text: 'üé• –í–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ' }],
      [{ text: '‚ùì –ü–æ–º–æ—â—å' }]
    ],
    resize_keyboard: true,
    one_time_keyboard: false
  };
  
  const welcomeMessage = `
üëã **–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ**

–Ø ‚Äî Gemini AI –±–æ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ –≤–∏–¥–µ–æ.

üîπ **–ß—Ç–æ —è —É–º–µ—é:**
‚Ä¢ üí¨ –í–µ—Å—Ç–∏ –±–µ—Å–µ–¥—É —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º AI
‚Ä¢ üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ç–µ–∫—Å—Ç
‚Ä¢ üé® –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –ø—Ä–æ–º–ø—Ç—É
‚Ä¢ üñºÔ∏è –°–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞
‚Ä¢ üé¨ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–∞
‚Ä¢ üé• –°–æ–∑–¥–∞–≤–∞—Ç—å –≤–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ

üìù **–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã** –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ:
  `;
  
  bot.sendMessage(chatId, welcomeMessage, { 
    reply_markup: keyboard,
    parse_mode: 'Markdown'
  });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Ä–µ–∂–∏–º–∞
function showModeKeyboard(chatId) {
  const keyboard = {
    keyboard: [
      [{ text: 'üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é' }]
    ],
    resize_keyboard: true,
    one_time_keyboard: false
  };
  
  return keyboard;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–º–æ—â–∏
function getHelpMessage() {
  return `
üÜò **–ü–û–ú–û–©–¨**

üí¨ **–ß–ê–¢ –° GEMINI:**
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "üí¨ –ß–∞—Ç —Å Gemini" –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
‚Ä¢ ü§ñ **–ú–æ–¥–µ–ª—å**: Gemini 2.5 Pro –∏–ª–∏ Flash
‚Ä¢ üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞**: –ù–∏–∑–∫–∞—è (—Ç–æ—á–Ω–æ—Å—Ç—å) / –°—Ä–µ–¥–Ω—è—è / –í—ã—Å–æ–∫–∞—è (–∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å)
‚Ä¢ üìä **–î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–æ–≤**: –ö–æ—Ä–æ—Ç–∫–∏–µ / –°—Ä–µ–¥–Ω–∏–µ / –î–ª–∏–Ω–Ω—ã–µ / –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ
‚Ä¢ üí≠ **–†–µ–∂–∏–º —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π**: –í–∫–ª—é—á–µ–Ω / –í—ã–∫–ª—é—á–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è Flash)

–í —Ä–µ–∂–∏–º–µ —á–∞—Ç–∞ –º–æ–¥–µ–ª—å –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

---

üîç **–ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô:**
–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
‚Ä¢ "–ò–∑–≤–ª–µ–∫–∏ —Ç–µ–∫—Å—Ç —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏"
‚Ä¢ "–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –Ω–∞ —Ñ–æ—Ç–æ?"

---

üé® **–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï:**
–û—Ç–ø—Ä–∞–≤—å—Ç–µ 1 –∏–ª–∏ 2 —Ñ–æ—Ç–æ + –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.

üì∑ **–° –æ–¥–Ω–∏–º —Ñ–æ—Ç–æ:**
‚Ä¢ "–ó–∞–º–µ–Ω–∏ —Å–∏–Ω–∏–π –¥–∏–≤–∞–Ω –Ω–∞ –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫–æ–∂–∞–Ω—ã–π"
‚Ä¢ "–î–æ–±–∞–≤—å –≤—è–∑–∞–Ω—É—é —à–ª—è–ø—É –Ω–∞ –≥–æ–ª–æ–≤—É –∫–æ—Ç–∞"
‚Ä¢ "–ò–∑–º–µ–Ω–∏ —Ñ–æ–Ω –Ω–∞ –ø–ª—è–∂–Ω—ã–π –ø–µ–π–∑–∞–∂"

üñºÔ∏èüñºÔ∏è **–° –¥–≤—É–º—è —Ñ–æ—Ç–æ (–∫–æ–º–ø–æ–∑–∏—Ü–∏—è/–ø–µ—Ä–µ–Ω–æ—Å —Å—Ç–∏–ª—è):**
‚Ä¢ "–ü–µ—Ä–µ–Ω–µ—Å–∏ —Å—Ç–∏–ª—å –ø–µ—Ä–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –≤—Ç–æ—Ä–æ–µ"
‚Ä¢ "–°–æ–∑–¥–∞–π –∫—Ä–æ—Å—Å-—Å—Ç–µ–∂–æ–∫ –º–æ–µ–≥–æ –∫–æ—Ç–∞ –Ω–∞ —ç—Ç–æ–π –ø–æ–¥—É—à–∫–µ"
‚Ä¢ "–û–±—ä–µ–¥–∏–Ω–∏ —ç—Ç–∏ –¥–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ–¥–Ω—É –∫–æ–º–ø–æ–∑–∏—Ü–∏—é"

---

üñºÔ∏è **–ì–ï–ù–ï–†–ê–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô:**
–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∂–µ–ª–∞–µ–º–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ "–ù–∞—Ä–∏—Å—É–π –∑–∞–∫–∞—Ç –Ω–∞ –º–æ—Ä–µ —Å –ø–∞—Ä—É—Å–Ω–∏–∫–æ–º"
‚Ä¢ "–°–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ç–∞ –≤ –∫–æ—Å–º–æ—Å–µ"
‚Ä¢ "–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥ –Ω–æ—á—å—é"

---

üé¨ **–ì–ï–ù–ï–†–ê–¶–ò–Ø –í–ò–î–ï–û:**
–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ (10-60 —Å–µ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è).

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ "–í–æ–¥–æ–ø–∞–¥ –≤ —Ç—Ä–æ–ø–∏—á–µ—Å–∫–æ–º –ª–µ—Å—É"
‚Ä¢ "–ú–∞—à–∏–Ω–∞ –µ–¥–µ—Ç –ø–æ –≥–æ—Ä–Ω–æ–π –¥–æ—Ä–æ–≥–µ –Ω–∞ –∑–∞–∫–∞—Ç–µ"
‚Ä¢ "–ü–æ–ª–µ—Ç –Ω–∞–¥ –æ–±–ª–∞–∫–∞–º–∏"

---

üé• **–í–ò–î–ï–û –ò–ó –§–û–¢–û:**
–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ + –æ–ø–∏—Å–∞–Ω–∏–µ –∂–µ–ª–∞–µ–º–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è.

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ "–î–æ–±–∞–≤—å –¥–≤–∏–∂–µ–Ω–∏–µ –æ–±–ª–∞–∫–æ–≤ –∏ –≤–æ–ª–Ω"
‚Ä¢ "–û–∂–∏–≤–∏ —ç—Ç—É —Å—Ü–µ–Ω—É —Å –ø–ª–∞–≤–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º –∫–∞–º–µ—Ä—ã"

---

üí° **–°–æ–≤–µ—Ç:** –ß–µ–º —Ç–æ—á–Ω–µ–µ –ø—Ä–æ–º–ø—Ç, —Ç–µ–º –ª—É—á—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!
  `;
}

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/^\/start$/, (msg) => {
  const chatId = msg.chat.id;
  showMainMenu(chatId);
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.onText(/^\/help$/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, getHelpMessage(), { 
    reply_markup: showModeKeyboard(chatId),
    parse_mode: 'Markdown'
  });
});

// –ö–æ–º–∞–Ω–¥–∞ /edit - –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
bot.onText(/^\/edit$/, async (msg) => {
  const chatId = msg.chat.id;
  const session = userSessions.get(chatId) || {};
  session.mode = 'edit';
  session.timestamp = Date.now();
  userSessions.set(chatId, session);
  
  // –û—á–∏—â–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  imageStorage.delete(chatId);
  
  await bot.sendMessage(chatId, `
üé® **–†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

üì± **–ú–æ–¥–µ–ª—å:** gemini-2.5-flash-image

–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ **1 –∏–ª–∏ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.

üì∑ **–° –æ–¥–Ω–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º:**
‚Ä¢ "–ó–∞–º–µ–Ω–∏ —Ñ–æ–Ω –Ω–∞ –≥–æ—Ä–Ω—ã–π –ø–µ–π–∑–∞–∂"
‚Ä¢ "–î–æ–±–∞–≤—å —Å–æ–ª–Ω–µ—á–Ω—ã–µ –æ—á–∫–∏ –Ω–∞ –ª–∏—Ü–æ"
‚Ä¢ "–ò–∑–º–µ–Ω–∏ —Ü–≤–µ—Ç –º–∞—à–∏–Ω—ã –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π"

üñºÔ∏èüñºÔ∏è **–° –¥–≤—É–º—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–∫–æ–º–ø–æ–∑–∏—Ü–∏—è/—Å—Ç–∏–ª—å):**
‚Ä¢ "–ü–µ—Ä–µ–Ω–µ—Å–∏ —Å—Ç–∏–ª—å –ø–µ—Ä–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –≤—Ç–æ—Ä–æ–µ"
‚Ä¢ "–°–æ–∑–¥–∞–π –∫—Ä–æ—Å—Å-—Å—Ç–µ–∂–æ–∫ –º–æ–µ–≥–æ –∫–æ—Ç–∞ –Ω–∞ —ç—Ç–æ–π –ø–æ–¥—É—à–∫–µ"
‚Ä¢ "–û–±—ä–µ–¥–∏–Ω–∏ —ç—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"

üí° **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
2Ô∏è‚É£ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
3Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π

‚úÖ –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Å—Ä–∞–∑—É —Å –ø–æ–¥–ø–∏—Å—å—é-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
  `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
});

// –ö–æ–º–∞–Ω–¥–∞ /analyze - –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞
bot.onText(/^\/analyze$/, (msg) => {
  const chatId = msg.chat.id;
  const session = userSessions.get(chatId) || {};
  session.mode = 'analyze';
  session.timestamp = Date.now();
  userSessions.set(chatId, session);
  
  bot.sendMessage(chatId, `
üîç **–†–ï–ñ–ò–ú –ê–ù–ê–õ–ò–ó–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø–∏—Å—ã–≤–∞—Ç—å –≤–∞—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤:
‚Ä¢ "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
‚Ä¢ "–ò–∑–≤–ª–µ–∫–∏ —Ç–µ–∫—Å—Ç —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏"
‚Ä¢ "–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –Ω–∞ —Ñ–æ—Ç–æ?"
‚Ä¢ "–û–ø—Ä–µ–¥–µ–ª–∏ –æ–±—ä–µ–∫—Ç—ã"
  `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
});

// –ö–æ–º–∞–Ω–¥–∞ /gen - –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
bot.onText(/^\/gen(?:\s+(.+))?$/, async (msg, match) => {
  const chatId = msg.chat.id;
  const prompt = match[1]; // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
  
  if (prompt) {
    // –ï—Å–ª–∏ –ø—Ä–æ–º–ø—Ç —É–∫–∞–∑–∞–Ω —Å—Ä–∞–∑—É –≤ –∫–æ–º–∞–Ω–¥–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
    // –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const session = userSessions.get(chatId) || {};
    session.pendingPrompt = prompt;
    session.timestamp = Date.now();
    userSessions.set(chatId, session);
    await showImageModelMenu(chatId, 'generate');
  } else {
    // –ï—Å–ª–∏ –ø—Ä–æ–º–ø—Ç –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
    await showImageModelMenu(chatId, 'generate');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /genvideo - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
bot.onText(/^\/genvideo(?:\s+(.+))?$/, async (msg, match) => {
  const chatId = msg.chat.id;
  const prompt = match[1]; // –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
  
  if (prompt) {
    // –ï—Å–ª–∏ –ø—Ä–æ–º–ø—Ç —É–∫–∞–∑–∞–Ω —Å—Ä–∞–∑—É –≤ –∫–æ–º–∞–Ω–¥–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
    // –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const session = userSessions.get(chatId) || {};
    session.pendingPrompt = prompt;
    session.timestamp = Date.now();
    userSessions.set(chatId, session);
    await showVideoModelMenu(chatId, 'genvideo');
  } else {
    // –ï—Å–ª–∏ –ø—Ä–æ–º–ø—Ç –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏
    await showVideoModelMenu(chatId, 'genvideo');
  }
});

// –ö–æ–º–∞–Ω–¥–∞ /genvideofrompicture - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
bot.onText(/^\/genvideofrompicture$/, async (msg) => {
  const chatId = msg.chat.id;
  await showVideoModelMenu(chatId, 'genvideofrompicture');
});

// –ö–æ–º–∞–Ω–¥–∞ /clear
bot.onText(/^\/clear$/, (msg) => {
  const chatId = msg.chat.id;
  userSessions.delete(chatId);
  imageStorage.delete(chatId); // –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  bot.sendMessage(chatId, '‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞!');
  showMainMenu(chatId);
});

// –ö–æ–º–∞–Ω–¥–∞ /chat - –ø–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Ç–∞
bot.onText(/^\/chat$/, async (msg) => {
  const chatId = msg.chat.id;
  
  try {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    if (!chatConfigs.has(chatId)) {
      chatConfigs.set(chatId, getDefaultChatConfig());
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
    await showChatConfigMenu(chatId);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
async function showImageModelMenu(chatId, mode) {
  // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const keyboard = {
    inline_keyboard: [
      [
        { text: '‚ö° imagen-4.0-fast-generate-001', callback_data: `imgmodel_${mode}_imagen-4.0-fast-generate-001` }
      ],
      [
        { text: 'üé® imagen-4.0-generate-001', callback_data: `imgmodel_${mode}_imagen-4.0-generate-001` }
      ],
      [
        { text: '‚ú® imagen-4.0-ultra-generate-001', callback_data: `imgmodel_${mode}_imagen-4.0-ultra-generate-001` }
      ],
      [
        { text: 'üñºÔ∏è imagen-3.0-generate-002', callback_data: `imgmodel_${mode}_imagen-3.0-generate-002` }
      ],
      [
        { text: 'ü§ñ gemini-2.5-flash-image', callback_data: `imgmodel_${mode}_gemini-2.5-flash-image` }
      ]
    ]
  };
  
  await bot.sendMessage(chatId, `
üñºÔ∏è **–í–´–ë–û–† –ú–û–î–ï–õ–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò**

–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏:

‚ö° **imagen-4.0-fast** - –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
üé® **imagen-4.0** - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
‚ú® **imagen-4.0-ultra** - –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
üñºÔ∏è **imagen-3.0** - –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è
ü§ñ **gemini-2.5-flash-image** - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å
  `, { 
    reply_markup: keyboard,
    parse_mode: 'Markdown'
  });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
async function showVideoModelMenu(chatId, mode) {
  const modeText = mode === 'genvideo' ? '–∏–∑ —Ç–µ–∫—Å—Ç–∞' : '–∏–∑ —Ñ–æ—Ç–æ';
  const modeEmoji = mode === 'genvideo' ? 'üé¨' : 'üé•';
  
  const keyboard = {
    inline_keyboard: [
      [
        { text: 'üé¨ veo-3.0-generate-001', callback_data: `videomodel_${mode}_veo-3.0-generate-001` }
      ],
      [
        { text: '‚ö° veo-3.0-fast-generate-001', callback_data: `videomodel_${mode}_veo-3.0-fast-generate-001` }
      ],
      [
        { text: 'üé• veo-2.0-generate-001', callback_data: `videomodel_${mode}_veo-2.0-generate-001` }
      ]
    ]
  };
  
  await bot.sendMessage(chatId, `
${modeEmoji} **–í–´–ë–û–† –ú–û–î–ï–õ–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –í–ò–î–ï–û ${modeText.toUpperCase()}**

–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ:

üé¨ **veo-3.0** - –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è
‚ö° **veo-3.0-fast** - –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
üé• **veo-2.0** - –ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–µ—Ä—Å–∏—è
  `, { 
    reply_markup: keyboard,
    parse_mode: 'Markdown'
  });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ (–∫–Ω–æ–ø–∫–∏)
bot.on('callback_query', async (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;
  
  try {
    // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback –¥–ª—è —Å–Ω—è—Ç–∏—è "–∑–∞–≥—Ä—É–∑–∫–∏" –∫–Ω–æ–ø–∫–∏
    await bot.answerCallbackQuery(query.id);
    
    if (data === 'end_chat') {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç-—Å–µ—Å—Å–∏—é (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —ç—Ç–æ—Ç callback –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
      chatSessions.delete(chatId);
      
      // –£–¥–∞–ª—è–µ–º inline-–∫–Ω–æ–ø–∫—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞
      await bot.editMessageText(
        '‚úÖ –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /chat, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç.',
        {
          chat_id: chatId,
          message_id: query.message.message_id
        }
      );
      
      console.log(`‚úÖ –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
      
    } else if (data === 'start_chat') {
      // –ó–∞–ø—É—Å–∫ —á–∞—Ç–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
      await startChatWithConfig(chatId, query.message.message_id);
      
    } else if (data.startsWith('config_')) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
      await handleConfigChange(chatId, data, query.message.message_id);
      
    } else if (data.startsWith('imgmodel_')) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      const parts = data.split('_');
      const mode = parts[1]; // 'generate' –∏–ª–∏ 'edit'
      const model = parts.slice(2).join('_'); // –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
      imageModels.set(`${chatId}_${mode}`, model);
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º
      const session = userSessions.get(chatId) || {};
      session.mode = mode;
      session.timestamp = Date.now();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const pendingPrompt = session.pendingPrompt;
      
      userSessions.set(chatId, session);
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –º–æ–¥–µ–ª–∏
      try {
        await bot.deleteMessage(chatId, query.message.message_id);
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
      }
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏, —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
      if (mode === 'generate' && pendingPrompt) {
        // –û—á–∏—â–∞–µ–º pendingPrompt –∏–∑ —Å–µ—Å—Å–∏–∏
        session.pendingPrompt = null;
        userSessions.set(chatId, session);
        
        await bot.sendMessage(chatId, `‚úÖ **–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å:** \`${model}\``, { parse_mode: 'Markdown' });
        await processImageGeneration(chatId, pendingPrompt);
        
        console.log(`‚úÖ –ú–æ–¥–µ–ª—å ${model} –≤—ã–±—Ä–∞–Ω–∞ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
      } else if (mode === 'generate') {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        await bot.sendMessage(chatId, `
‚úÖ **–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å:** \`${model}\`

üñºÔ∏è **–†–ï–ñ–ò–ú –ì–ï–ù–ï–†–ê–¶–ò–ò –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å.

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤:
‚Ä¢ "–ù–∞—Ä–∏—Å—É–π –∑–∞–∫–∞—Ç –Ω–∞ –º–æ—Ä–µ —Å –ø–∞—Ä—É—Å–Ω–∏–∫–æ–º"
‚Ä¢ "–°–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ç–∞ –≤ –∫–æ—Å–º–æ—Å–µ"
‚Ä¢ "–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥ –Ω–æ—á—å—é, –Ω–µ–æ–Ω–æ–≤—ã–µ –æ–≥–Ω–∏"
‚Ä¢ "–ú–∏–ª—ã–π —Ä–æ–±–æ—Ç —Å –±—É–∫–µ—Ç–æ–º —Ü–≤–µ—Ç–æ–≤, –∞–∫–≤–∞—Ä–µ–ª—å–Ω—ã–π —Å—Ç–∏–ª—å"

üí° –°–æ–≤–µ—Ç—ã:
‚úÖ –û–ø–∏—Å—ã–≤–∞–π—Ç–µ –¥–µ—Ç–∞–ª–∏ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É
‚úÖ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å—Ç–∏–ª—å (—Ä–µ–∞–ª–∏–∑–º, –∞—Ä—Ç, –∞–∫–≤–∞—Ä–µ–ª—å –∏ —Ç.–¥.)
‚úÖ –£–ø–æ–º–∏–Ω–∞–π—Ç–µ —Ü–≤–µ—Ç–∞ –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é
        `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
        
        console.log(`‚úÖ –ú–æ–¥–µ–ª—å ${model} –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ ${mode} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${chatId}`);
      }
    } else if (data.startsWith('videomodel_')) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ
      const parts = data.split('_');
      const mode = parts[1]; // 'genvideo' –∏–ª–∏ 'genvideofrompicture'
      const model = parts.slice(2).join('_'); // –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
      videoModels.set(`${chatId}_${mode}`, model);
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º
      const session = userSessions.get(chatId) || {};
      session.mode = mode;
      session.timestamp = Date.now();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const pendingPrompt = session.pendingPrompt;
      
      userSessions.set(chatId, session);
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º –º–æ–¥–µ–ª–∏
      try {
        await bot.deleteMessage(chatId, query.message.message_id);
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
      }
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ, —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
      if (mode === 'genvideo' && pendingPrompt) {
        // –û—á–∏—â–∞–µ–º pendingPrompt –∏–∑ —Å–µ—Å—Å–∏–∏
        session.pendingPrompt = null;
        userSessions.set(chatId, session);
        
        await bot.sendMessage(chatId, `‚úÖ **–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å:** \`${model}\``, { parse_mode: 'Markdown' });
        await processVideoGeneration(chatId, pendingPrompt);
        
        console.log(`‚úÖ –ú–æ–¥–µ–ª—å ${model} –≤—ã–±—Ä–∞–Ω–∞ –∏ –≤–∏–¥–µ–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
      } else {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        if (mode === 'genvideo') {
          await bot.sendMessage(chatId, `
‚úÖ **–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å:** \`${model}\`

üé¨ **–†–ï–ñ–ò–ú –ì–ï–ù–ï–†–ê–¶–ò–ò –í–ò–î–ï–û –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å.

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤:
‚Ä¢ "–í–æ–¥–æ–ø–∞–¥ –≤ —Ç—Ä–æ–ø–∏—á–µ—Å–∫–æ–º –ª–µ—Å—É —Å –ø—Ç–∏—Ü–∞–º–∏"
‚Ä¢ "–ú–∞—à–∏–Ω–∞ –µ–¥–µ—Ç –ø–æ –≥–æ—Ä–Ω–æ–π –¥–æ—Ä–æ–≥–µ –Ω–∞ –∑–∞–∫–∞—Ç–µ"
‚Ä¢ "–ü–æ–ª–µ—Ç –Ω–∞–¥ –æ–±–ª–∞–∫–∞–º–∏ –≤ –∑–æ–ª–æ—Ç–æ–π —á–∞—Å"
‚Ä¢ "–ö–æ—Ç –∏–≥—Ä–∞–µ—Ç —Å –∫—Ä–∞—Å–Ω—ã–º –º—è—á–∏–∫–æ–º –Ω–∞ —Ç—Ä–∞–≤–µ"

üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
‚úÖ –û–ø–∏—Å—ã–≤–∞–π—Ç–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∏ –¥–µ–π—Å—Ç–≤–∏—è
‚úÖ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –¥–µ—Ç–∞–ª–∏ —Å—Ü–µ–Ω—ã
‚úÖ –î–æ–±–∞–≤–ª—è–π—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–≤–µ—â–µ–Ω–∏—è –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã
‚úÖ –£–ø–æ–º–∏–Ω–∞–π—Ç–µ –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã

‚è±Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–Ω–∏–º–∞–µ—Ç 10-60 —Å–µ–∫—É–Ω–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ!
          `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
        } else if (mode === 'genvideofrompicture') {
          await bot.sendMessage(chatId, `
‚úÖ **–í—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å:** \`${model}\`

üé• **–†–ï–ñ–ò–ú –ì–ï–ù–ï–†–ê–¶–ò–ò –í–ò–î–ï–û –ò–ó –§–û–¢–û –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∂–µ–ª–∞–µ–º–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –∏–ª–∏ –∞–Ω–∏–º–∞—Ü–∏–∏.

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–º–ø—Ç–æ–≤:
‚Ä¢ "–î–æ–±–∞–≤—å –¥–≤–∏–∂–µ–Ω–∏–µ –æ–±–ª–∞–∫–æ–≤ –∏ –≤–æ–ª–Ω"
‚Ä¢ "–û–∂–∏–≤–∏ —ç—Ç—É —Å—Ü–µ–Ω—É —Å –ø–ª–∞–≤–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º –∫–∞–º–µ—Ä—ã —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ"
‚Ä¢ "–î–æ–±–∞–≤—å —ç—Ñ—Ñ–µ–∫—Ç –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ zoom in"
‚Ä¢ "–°–æ–∑–¥–∞–π —ç—Ñ—Ñ–µ–∫—Ç –ø–∞—Ä–∞–ª–ª–∞–∫—Å–∞ —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º –Ω–∞ —Ñ–æ–Ω–µ"

üí° –°–æ–≤–µ—Ç—ã:
‚úÖ –û–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å
‚úÖ –£–∫–∞–∂–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
‚úÖ –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –∏ —Å—Ç–∏–ª—è
‚úÖ –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–µ–º—ã

‚è±Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–Ω–∏–º–∞–µ—Ç 10-60 —Å–µ–∫—É–Ω–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ!
          `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
        }
        
        console.log(`‚úÖ –ú–æ–¥–µ–ª—å ${model} –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ ${mode} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${chatId}`);
      }
    } else if (data.startsWith('regen_')) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const parts = data.split('_');
      const type = parts[1]; // 'img', 'edit', 'video', 'videofromimg'
      const promptKey = `${chatId}_${type}`;
      const savedData = regeneratePrompts.get(promptKey);
      
      if (!savedData) {
        await bot.answerCallbackQuery(query.id, {
          text: '‚ö†Ô∏è –ü—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
          show_alert: true
        });
        return;
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      try {
        await bot.editMessageReplyMarkup(
          { inline_keyboard: [] },
          {
            chat_id: chatId,
            message_id: query.message.message_id
          }
        );
      } catch (e) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
      }
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
      if (type === 'img') {
        await bot.sendMessage(chatId, 'üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
        await processImageGeneration(chatId, savedData.prompt);
      } else if (type === 'edit') {
        await bot.sendMessage(chatId, 'üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
        await processImageEdit(chatId, savedData.images, savedData.prompt, savedData.imageId);
      } else if (type === 'video') {
        await bot.sendMessage(chatId, 'üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ...');
        await processVideoGeneration(chatId, savedData.prompt);
      } else if (type === 'videofromimg') {
        await bot.sendMessage(chatId, 'üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
        await processVideoGenerationFromImage(chatId, savedData.image, savedData.prompt, savedData.imageId);
      }
      
      console.log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (${type}) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback:', error);
    await bot.answerCallbackQuery(query.id, {
      text: '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞',
      show_alert: false
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
bot.on('photo', async (msg) => {
  const chatId = msg.chat.id;
  
  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
    await bot.sendChatAction(chatId, 'typing');
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
    const photo = msg.photo[msg.photo.length - 1];
    const fileId = photo.file_id;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª
    const file = await bot.getFile(fileId);
    const fileUrl = `https://api.telegram.org/file/bot${process.env.TELEGRAM_BOT_TOKEN}/${file.file_path}`;
    
    // –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const response = await axios.get(fileUrl, { responseType: 'arraybuffer' });
    const imageBuffer = Buffer.from(response.data);
    const base64Image = imageBuffer.toString('base64');
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const session = userSessions.get(chatId) || {};
    const mode = session.mode || 'analyze'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞
    
    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–ø—Ç –∏–∑ –ø–æ–¥–ø–∏—Å–∏ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    const caption = msg.caption || '';
    
    if (caption) {
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å, —Å—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
      if (mode === 'edit') {
        // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø–æ–¥–ø–∏—Å—å—é - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å –æ–¥–Ω–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        await processImageEdit(chatId, [base64Image], caption, photo.file_unique_id);
        
        // –û—á–∏—â–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        imageStorage.delete(chatId);
      } else if (mode === 'genvideofrompicture') {
        await processVideoGenerationFromImage(chatId, base64Image, caption, photo.file_unique_id);
      } else {
        await processImageWithPrompt(chatId, base64Image, caption, photo.file_unique_id);
      }
    } else {
      // –†–µ–∂–∏–º –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (mode === 'edit') {
        // –í —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ imageStorage –¥–ª—è –º—É–ª—å—Ç–∏–æ–±—Ä–∞–∑–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        const images = imageStorage.get(chatId) || [];
        images.push(base64Image);
        imageStorage.set(chatId, images);
        
        const imageCount = images.length;
        
        if (imageCount === 1) {
          bot.sendMessage(chatId, `üì∏ **–ü–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ!**\n\n–í—ã –º–æ–∂–µ—Ç–µ:\n‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏/–ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç–∏–ª—è\n‚Ä¢ –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è`);
        } else if (imageCount === 2) {
          bot.sendMessage(chatId, `üñºÔ∏èüñºÔ∏è **–î–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω—ã!**\n\n–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.\n\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n‚Ä¢ "–ü–µ—Ä–µ–Ω–µ—Å–∏ —Å—Ç–∏–ª—å –ø–µ—Ä–≤–æ–≥–æ –Ω–∞ –≤—Ç–æ—Ä–æ–µ"\n‚Ä¢ "–°–æ–∑–¥–∞–π –∫—Ä–æ—Å—Å-—Å—Ç–µ–∂–æ–∫ –∫–æ—Ç–∞ –Ω–∞ –ø–æ–¥—É—à–∫–µ"\n‚Ä¢ "–û–±—ä–µ–¥–∏–Ω–∏ —ç—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"`);
        } else {
          // –ë–æ–ª—å—à–µ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 2
          bot.sendMessage(chatId, `‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É—é –ø–µ—Ä–≤—ã–µ –¥–≤–∞.\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.`);
        }
      } else {
        // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–æ–≤ (analyze, genvideofrompicture) - —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞
        userSessions.set(chatId, {
          imageData: base64Image,
          imageId: photo.file_unique_id,
          mode: mode,
          timestamp: Date.now()
        });
        
        let modeText;
        if (mode === 'genvideofrompicture') {
          modeText = 'üé• –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∂–µ–ª–∞–µ–º–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è.\n\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n‚Ä¢ "–î–æ–±–∞–≤—å –¥–≤–∏–∂–µ–Ω–∏–µ –æ–±–ª–∞–∫–æ–≤"\n‚Ä¢ "–û–∂–∏–≤–∏ —Å—Ü–µ–Ω—É —Å –ø–ª–∞–≤–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º –∫–∞–º–µ—Ä—ã"';
        } else {
          modeText = 'üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –ø—Ä–æ–º–ø—Ç.\n\n–ù–∞–ø—Ä–∏–º–µ—Ä:\n‚Ä¢ "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"\n‚Ä¢ "–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å?"';
        }
        
        bot.sendMessage(chatId, modeText);
      }
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
    bot.sendMessage(
      chatId, 
      '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', async (msg) => {
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–æ—Ç–æ
  if (msg.text && !msg.text.startsWith('/') && !msg.photo) {
    const chatId = msg.chat.id;
    const text = msg.text;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    if (text === 'üí¨ –ß–∞—Ç —Å Gemini') {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
      if (!chatConfigs.has(chatId)) {
        chatConfigs.set(chatId, getDefaultChatConfig());
      }
      await showChatConfigMenu(chatId);
      return;
    }
    
    if (text === 'üîç –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π') {
      const session = userSessions.get(chatId) || {};
      session.mode = 'analyze';
      session.timestamp = Date.now();
      userSessions.set(chatId, session);
      
      await bot.sendMessage(chatId, `
üîç **–†–ï–ñ–ò–ú –ê–ù–ê–õ–ò–ó–ê –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

–¢–µ–ø–µ—Ä—å —è –±—É–¥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø–∏—Å—ã–≤–∞—Ç—å –≤–∞—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é:
‚Ä¢ "–û–ø–∏—à–∏ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
‚Ä¢ "–ò–∑–≤–ª–µ–∫–∏ —Ç–µ–∫—Å—Ç —Å –∫–∞—Ä—Ç–∏–Ω–∫–∏"
‚Ä¢ "–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å –Ω–∞ —Ñ–æ—Ç–æ?"
‚Ä¢ "–û–ø—Ä–µ–¥–µ–ª–∏ –æ–±—ä–µ–∫—Ç—ã"
      `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
      return;
    }
    
    if (text === 'üé® –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') {
      const session = userSessions.get(chatId) || {};
      session.mode = 'edit';
      session.timestamp = Date.now();
      userSessions.set(chatId, session);
      
      // –û—á–∏—â–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      imageStorage.delete(chatId);
      
      await bot.sendMessage(chatId, `
üé® **–†–ï–ñ–ò–ú –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ê–ö–¢–ò–í–ò–†–û–í–ê–ù**

üì± **–ú–æ–¥–µ–ª—å:** gemini-2.5-flash-image

–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ **1 –∏–ª–∏ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è** —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏.

üì∑ **–° –æ–¥–Ω–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º:**
‚Ä¢ "–ó–∞–º–µ–Ω–∏ —Ñ–æ–Ω –Ω–∞ –≥–æ—Ä–Ω—ã–π –ø–µ–π–∑–∞–∂"
‚Ä¢ "–î–æ–±–∞–≤—å —Å–æ–ª–Ω–µ—á–Ω—ã–µ –æ—á–∫–∏ –Ω–∞ –ª–∏—Ü–æ"
‚Ä¢ "–ò–∑–º–µ–Ω–∏ —Ü–≤–µ—Ç –º–∞—à–∏–Ω—ã –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π"

üñºÔ∏èüñºÔ∏è **–° –¥–≤—É–º—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–∫–æ–º–ø–æ–∑–∏—Ü–∏—è/—Å—Ç–∏–ª—å):**
‚Ä¢ "–ü–µ—Ä–µ–Ω–µ—Å–∏ —Å—Ç–∏–ª—å –ø–µ—Ä–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –≤—Ç–æ—Ä–æ–µ"
‚Ä¢ "–°–æ–∑–¥–∞–π –∫—Ä–æ—Å—Å-—Å—Ç–µ–∂–æ–∫ –º–æ–µ–≥–æ –∫–æ—Ç–∞ –Ω–∞ —ç—Ç–æ–π –ø–æ–¥—É—à–∫–µ"
‚Ä¢ "–û–±—ä–µ–¥–∏–Ω–∏ —ç—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"

üí° **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
2Ô∏è‚É£ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ (–±–µ–∑ –ø–æ–¥–ø–∏—Å–∏)
3Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π

‚úÖ –ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Å—Ä–∞–∑—É —Å –ø–æ–¥–ø–∏—Å—å—é-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
      `, { reply_markup: showModeKeyboard(chatId), parse_mode: 'Markdown' });
      return;
    }
    
    if (text === 'üñºÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π') {
      await showImageModelMenu(chatId, 'generate');
      return;
    }
    
    if (text === 'üé¨ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ') {
      await showVideoModelMenu(chatId, 'genvideo');
      return;
    }
    
    if (text === 'üé• –í–∏–¥–µ–æ –∏–∑ —Ñ–æ—Ç–æ') {
      await showVideoModelMenu(chatId, 'genvideofrompicture');
      return;
    }
    
    if (text === '‚ùì –ü–æ–º–æ—â—å') {
      await bot.sendMessage(chatId, getHelpMessage(), { 
        reply_markup: showModeKeyboard(chatId),
        parse_mode: 'Markdown'
      });
      return;
    }
    
    if (text === 'üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é') {
      // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userSessions.delete(chatId);
      imageStorage.delete(chatId); // –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      showMainMenu(chatId);
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∞—Ç–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞ "–û–∫–æ–Ω—á–∏—Ç—å —á–∞—Ç"
    if (text === '‚ùå –û–∫–æ–Ω—á–∏—Ç—å —á–∞—Ç') {
      const chatSession = chatSessions.get(chatId);
      if (chatSession) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç-—Å–µ—Å—Å–∏—é
        chatSessions.delete(chatId);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        await bot.sendMessage(chatId, '‚úÖ –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç. –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞.');
        showMainMenu(chatId);
        
        console.log(`‚úÖ –ß–∞—Ç –∑–∞–∫—Ä—ã—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId} —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã`);
        return;
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è —á–∞—Ç-—Å–µ—Å—Å–∏—è
    const chatSession = chatSessions.get(chatId);
    if (chatSession) {
      await processChatMessage(chatId, text);
      return;
    }
    
    const userSession = userSessions.get(chatId);
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (userSession && userSession.mode === 'generate' && !userSession.imageData) {
      const prompt = msg.text;
      await processImageGeneration(chatId, prompt);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      userSessions.set(chatId, {
        mode: 'generate',
        timestamp: Date.now()
      });
      return;
    }
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (userSession && userSession.mode === 'genvideo' && !userSession.imageData) {
      const prompt = msg.text;
      await processVideoGeneration(chatId, prompt);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      userSessions.set(chatId, {
        mode: 'genvideo',
        timestamp: Date.now()
      });
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ imageStorage (—Ä–µ–∂–∏–º –º—É–ª—å—Ç–∏–æ–±—Ä–∞–∑–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    const storedImages = imageStorage.get(chatId);
    if (userSession && userSession.mode === 'edit' && storedImages && storedImages.length > 0) {
      const prompt = msg.text;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
      await processImageEdit(
        chatId, 
        storedImages, 
        prompt, 
        'multi'
      );
      
      // –û—á–∏—â–∞–µ–º imageStorage –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      imageStorage.delete(chatId);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º
      userSessions.set(chatId, {
        mode: 'edit',
        timestamp: Date.now()
      });
      
      return;
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ä–µ–∂–∏–º–æ–≤)
    if (userSession && userSession.imageData) {
      const prompt = msg.text;
      const mode = userSession.mode || 'analyze';
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
      if (mode === 'edit') {
        await processImageEdit(
          chatId, 
          [userSession.imageData], 
          prompt, 
          userSession.imageId
        );
      } else if (mode === 'genvideofrompicture') {
        await processVideoGenerationFromImage(
          chatId, 
          userSession.imageData, 
          prompt, 
          userSession.imageId
        );
      } else {
        await processImageWithPrompt(
          chatId, 
          userSession.imageData, 
          prompt, 
          userSession.imageId
        );
      }
      
      // –û—á–∏—â–∞–µ–º imageData, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∂–∏–º
      const currentMode = userSession.mode;
      userSessions.set(chatId, {
        mode: currentMode,
        timestamp: Date.now()
      });
    }
  }
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
function getDefaultChatConfig() {
  return {
    model: 'gemini-2.5-pro',
    temperature: 0.7,
    maxOutputTokens: 2048,
    thinkingEnabled: true,
    systemInstruction: null
  };
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Å —Ç–µ–∫—É—â–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
function getConfigText(config) {
  const modelName = config.model === 'gemini-2.5-pro' ? 'Gemini 2.5 Pro' : 'Gemini 2.5 Flash';
  
  let tempText;
  if (config.temperature <= 0.3) {
    tempText = '‚ùÑÔ∏è –ù–∏–∑–∫–∞—è (—Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã)';
  } else if (config.temperature <= 0.7) {
    tempText = 'üå§Ô∏è –°—Ä–µ–¥–Ω—è—è (—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ)';
  } else {
    tempText = 'üî• –í—ã—Å–æ–∫–∞—è (–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã)';
  }
  
  let tokensText;
  if (config.maxOutputTokens <= 1024) {
    tokensText = 'üìù –ö–æ—Ä–æ—Ç–∫–∏–µ (1024)';
  } else if (config.maxOutputTokens <= 2048) {
    tokensText = 'üìÑ –°—Ä–µ–¥–Ω–∏–µ (2048)';
  } else if (config.maxOutputTokens <= 4096) {
    tokensText = 'üìö –î–ª–∏–Ω–Ω—ã–µ (4096)';
  } else {
    tokensText = 'üìñ –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ (8192)';
  }
  
  const thinkingText = config.thinkingEnabled ? 'üß† –í–∫–ª—é—á–µ–Ω' : '‚ö° –í—ã–∫–ª—é—á–µ–Ω';
  
  return `
‚öôÔ∏è **–ù–ê–°–¢–†–û–ô–ö–ò –ß–ê–¢–ê**

ü§ñ **–ú–æ–¥–µ–ª—å**: ${modelName}
üå°Ô∏è **–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞**: ${tempText}
üìä **–î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞**: ${tokensText}
üí≠ **–†–µ–∂–∏–º —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π**: ${thinkingText}
${config.systemInstruction ? `\nüìã **–°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞` : ''}

üí° –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–∞—Ç–∞ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –Ω–∏–∂–µ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —á–∞—Ç".
  `;
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
function getChatConfigKeyboard(config) {
  const modelEmoji = config.model === 'gemini-2.5-pro' ? 'üéì' : '‚ö°';
  
  let tempEmoji;
  if (config.temperature <= 0.3) tempEmoji = '‚ùÑÔ∏è';
  else if (config.temperature <= 0.7) tempEmoji = 'üå§Ô∏è';
  else tempEmoji = 'üî•';
  
  const thinkingEmoji = config.thinkingEnabled ? 'üß†' : '‚ö°';
  
  return {
    inline_keyboard: [
      [
        { text: `${modelEmoji} –ú–æ–¥–µ–ª—å`, callback_data: 'config_model' }
      ],
      [
        { text: `${tempEmoji} –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞`, callback_data: 'config_temperature' }
      ],
      [
        { text: `üìä –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞`, callback_data: 'config_tokens' }
      ],
      [
        { text: `${thinkingEmoji} –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è`, callback_data: 'config_thinking' }
      ],
      [
        { text: '‚úÖ –ù–∞—á–∞—Ç—å —á–∞—Ç', callback_data: 'start_chat' }
      ]
    ]
  };
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
async function showChatConfigMenu(chatId, messageId = null) {
  const config = chatConfigs.get(chatId) || getDefaultChatConfig();
  const text = getConfigText(config);
  const keyboard = getChatConfigKeyboard(config);
  
  if (messageId) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.editMessageText(text, {
      chat_id: chatId,
      message_id: messageId,
      reply_markup: keyboard,
      parse_mode: 'Markdown'
    });
  } else {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.sendMessage(chatId, text, {
      reply_markup: keyboard,
      parse_mode: 'Markdown'
    });
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
async function handleConfigChange(chatId, data, messageId) {
  const config = chatConfigs.get(chatId) || getDefaultChatConfig();
  
  if (data === 'config_model') {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–æ–¥–µ–ª—å
    config.model = config.model === 'gemini-2.5-pro' ? 'gemini-2.5-flash' : 'gemini-2.5-pro';
    
  } else if (data === 'config_temperature') {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É: 0.2 -> 0.7 -> 1.2 -> 0.2
    if (config.temperature <= 0.3) {
      config.temperature = 0.7;
    } else if (config.temperature <= 0.7) {
      config.temperature = 1.2;
    } else {
      config.temperature = 0.2;
    }
    
  } else if (data === 'config_tokens') {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: 1024 -> 2048 -> 4096 -> 8192 -> 1024
    if (config.maxOutputTokens <= 1024) {
      config.maxOutputTokens = 2048;
    } else if (config.maxOutputTokens <= 2048) {
      config.maxOutputTokens = 4096;
    } else if (config.maxOutputTokens <= 4096) {
      config.maxOutputTokens = 8192;
    } else {
      config.maxOutputTokens = 1024;
    }
    
  } else if (data === 'config_thinking') {
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π
    config.thinkingEnabled = !config.thinkingEnabled;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  chatConfigs.set(chatId, config);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
  await showChatConfigMenu(chatId, messageId);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —á–∞—Ç–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
async function startChatWithConfig(chatId, configMessageId) {
  try {
    const config = chatConfigs.get(chatId) || getDefaultChatConfig();
    
    console.log(`üí¨ –ó–∞–ø—É—Å–∫ —á–∞—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId} —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:`, config);
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è Gemini
    const chatConfig = {
      temperature: config.temperature,
      maxOutputTokens: config.maxOutputTokens,
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è flash –º–æ–¥–µ–ª–∏
    if (config.model === 'gemini-2.5-flash') {
      chatConfig.thinkingConfig = {
        thinkingBudget: config.thinkingEnabled ? undefined : 0
      };
    }
    
    // –°–æ–∑–¥–∞–µ–º —á–∞—Ç-—Å–µ—Å—Å–∏—é
    const chatOptions = {
      model: config.model,
      history: []
    };
    
    if (chatConfig) {
      chatOptions.config = chatConfig;
    }
    
    if (config.systemInstruction) {
      chatOptions.systemInstruction = config.systemInstruction;
    }
    
    const chat = ai.chats.create(chatOptions);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç-—Å–µ—Å—Å–∏—é
    chatSessions.set(chatId, {
      chat: chat,
      config: config,
      timestamp: Date.now()
    });
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    try {
      await bot.deleteMessage(chatId, configMessageId);
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–û–∫–æ–Ω—á–∏—Ç—å —á–∞—Ç"
    const keyboard = {
      keyboard: [
        [{ text: '‚ùå –û–∫–æ–Ω—á–∏—Ç—å —á–∞—Ç' }]
      ],
      resize_keyboard: true,
      one_time_keyboard: false
    };
    
    const modelName = config.model === 'gemini-2.5-pro' ? 'Gemini 2.5 Pro' : 'Gemini 2.5 Flash';
    
    await bot.sendMessage(chatId, `
üí¨ **–ß–ê–¢ –û–¢–ö–†–´–¢**

ü§ñ –ú–æ–¥–µ–ª—å: **${modelName}**
üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: **${config.temperature}**
üìä –ú–∞–∫—Å. —Ç–æ–∫–µ–Ω–æ–≤: **${config.maxOutputTokens}**
${config.model === 'gemini-2.5-flash' ? `üí≠ –†–∞–∑–º—ã—à–ª–µ–Ω–∏—è: **${config.thinkingEnabled ? '–í–∫–ª' : '–í—ã–∫–ª'}**\n` : ''}
–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—â–∞—Ç—å—Å—è —Å –º–æ–¥–µ–ª—å—é. –Ø –±—É–¥—É –ø–æ–º–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–æ –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏ —è –±—É–¥—É –Ω–∞ –Ω–∏—Ö –æ—Ç–≤–µ—á–∞—Ç—å!

üí° –ß—Ç–æ–±—ã –∑–∞–∫–æ–Ω—á–∏—Ç—å —á–∞—Ç, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –Ω–∏–∂–µ.
    `, { reply_markup: keyboard, parse_mode: 'Markdown' });
    
    console.log(`‚úÖ –ß–∞—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–∞—Ç–∞:', error);
    bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–∞—Ç–∞:\n\n${error.message}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —Å –ø–æ–º–æ—â—å—é /chat`);
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ —Å Gemini 2.5 Pro
async function processChatMessage(chatId, message) {
  try {
    await bot.sendChatAction(chatId, 'typing');
    
    const chatSession = chatSessions.get(chatId);
    if (!chatSession) {
      bot.sendMessage(chatId, '‚ö†Ô∏è –ß–∞—Ç-—Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /chat, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç.');
      return;
    }
    
    console.log(`üí¨ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}: ${message}`);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
    const response = await chatSession.chat.sendMessage({
      message: message
    });
    
    console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Gemini –ø–æ–ª—É—á–µ–Ω');
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
    let resultText = '';
    
    if (response.text) {
      resultText = response.text;
    } else if (response.candidates && response.candidates[0]) {
      const candidate = response.candidates[0];
      if (candidate.content && candidate.content.parts) {
        resultText = candidate.content.parts.map(p => p.text).join('');
      }
    }
    
    console.log('üìù –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞:', resultText?.length || 0);
    
    if (resultText && resultText.trim()) {
      // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —á–∞—Å—Ç–∏ (Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤)
      const maxLength = 4000;
      if (resultText.length > maxLength) {
        const chunks = resultText.match(new RegExp(`.{1,${maxLength}}`, 'g'));
        for (const chunk of chunks) {
          await bot.sendMessage(chatId, chunk, { parse_mode: 'Markdown' });
        }
      } else {
        await bot.sendMessage(chatId, resultText, { parse_mode: 'Markdown' });
      }
    } else {
      console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini');
      bot.sendMessage(chatId, '‚ö†Ô∏è Gemini –Ω–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å.');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º timestamp —Å–µ—Å—Å–∏–∏
    chatSession.timestamp = Date.now();
    chatSessions.set(chatId, chatSession);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ:');
    console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
    console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.\n\n';
    
    if (error.message) {
      errorMessage += `–î–µ—Ç–∞–ª–∏: ${error.message}`;
    }
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ API
    if (error.message && error.message.includes('API key')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ Gemini –≤ —Ñ–∞–π–ª–µ .env';
    } else if (error.message && error.message.includes('quota')) {
      errorMessage += '\n\nüí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    } else if (error.message && error.message.includes('model')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–æ–¥–µ–ª—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –∫–æ–¥–µ.';
    } else if (error.message && error.message.includes('permission')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞.';
    }
    
    bot.sendMessage(chatId, errorMessage);
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–æ–º–ø—Ç–æ–º
async function processImageWithPrompt(chatId, base64Image, prompt, imageId) {
  try {
    await bot.sendChatAction(chatId, 'typing');
    
    bot.sendMessage(chatId, 'üîÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é Gemini AI...');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é JPEG)
    const mimeType = 'image/jpeg';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Gemini
    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: [
        {
          role: 'user',
          parts: [
            {
              text: prompt
            },
            {
              inlineData: {
                mimeType: mimeType,
                data: base64Image
              }
            }
          ]
        }
      ],
      config: {
        temperature: 0.7,
        maxOutputTokens: 2048,
      }
    });
    
    console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Gemini –ø–æ–ª—É—á–µ–Ω');
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –æ—Ç–≤–µ—Ç–∞
    let resultText = '';
    
    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    if (response.text) {
      resultText = response.text;
    } else if (response.candidates && response.candidates[0]) {
      const candidate = response.candidates[0];
      if (candidate.content && candidate.content.parts) {
        resultText = candidate.content.parts.map(p => p.text).join('');
      }
    }
    
    console.log('üìù –î–ª–∏–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', resultText?.length || 0);
    
    if (resultText && resultText.trim()) {
      // –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —á–∞—Å—Ç–∏ (Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤)
      const maxLength = 4000;
      if (resultText.length > maxLength) {
        const chunks = resultText.match(new RegExp(`.{1,${maxLength}}`, 'g'));
        for (const chunk of chunks) {
          await bot.sendMessage(chatId, chunk);
        }
      } else {
        await bot.sendMessage(chatId, `‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:\n\n${resultText}`);
      }
    } else {
      console.log('‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini. –ü–æ–ª–Ω—ã–π response:', JSON.stringify(response, null, 2));
      bot.sendMessage(chatId, '‚ö†Ô∏è Gemini –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–º–ø—Ç.');
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini AI:');
    console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
    console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.\n\n';
    
    if (error.message) {
      errorMessage += `–î–µ—Ç–∞–ª–∏: ${error.message}`;
    }
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ API
    if (error.message && error.message.includes('API key')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ Gemini –≤ —Ñ–∞–π–ª–µ .env';
    } else if (error.message && error.message.includes('quota')) {
      errorMessage += '\n\nüí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    } else if (error.message && error.message.includes('model')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–æ–¥–µ–ª—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ –∫–æ–¥–µ.';
    } else if (error.message && error.message.includes('permission')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞.';
    }
    
    bot.sendMessage(chatId, errorMessage);
  }
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–æ–º–ø—Ç–æ–º (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ 1 –∏–ª–∏ 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
async function processImageEdit(chatId, base64Images, prompt, imageId) {
  try {
    await bot.sendChatAction(chatId, 'upload_photo');
    
    // –î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º gemini-2.5-flash-image
    const selectedModel = 'gemini-2.5-flash-image';
    
    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ base64Images - —ç—Ç–æ –º–∞—Å—Å–∏–≤
    const imagesArray = Array.isArray(base64Images) ? base64Images : [base64Images];
    const imageCount = Math.min(imagesArray.length, 2); // –ú–∞–∫—Å–∏–º—É–º 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    const imageText = imageCount === 1 ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : `${imageCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è`;
    bot.sendMessage(chatId, `üé® –†–µ–¥–∞–∫—Ç–∏—Ä—É—é ${imageText} —Å –ø–æ–º–æ—â—å—é Gemini AI...\n‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥...`);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME —Ç–∏–ø (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é JPEG)
    const mimeType = 'image/jpeg';
    
    console.log('üé® –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    console.log('ü§ñ –ú–æ–¥–µ–ª—å:', selectedModel);
    console.log('üìù –ü—Ä–æ–º–ø—Ç:', prompt);
    console.log('üñºÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', imageCount);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º parts –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
    const parts = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –ø–µ—Ä–≤—ã–º
    parts.push({
      text: prompt
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    for (let i = 0; i < imageCount; i++) {
      parts.push({
        inlineData: {
          mimeType: mimeType,
          data: imagesArray[i]
        }
      });
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Gemini –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const response = await ai.models.generateContent({
      model: selectedModel,
      contents: [
        {
          role: 'user',
          parts: parts
        }
      ],
      config: {
        temperature: 0.7,
      }
    });
    
    console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Gemini –ø–æ–ª—É—á–µ–Ω');
    
    // –ò—â–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ
    let editedImageBase64 = null;
    let textResponse = '';
    
    if (response.candidates && response.candidates[0]) {
      const candidate = response.candidates[0];
      if (candidate.content && candidate.content.parts) {
        for (const part of candidate.content.parts) {
          if (part.inlineData && part.inlineData.data) {
            editedImageBase64 = part.inlineData.data;
            console.log('üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ');
          }
          if (part.text) {
            textResponse = part.text;
          }
        }
      }
    }
    
    if (editedImageBase64) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º base64 –æ–±—Ä–∞—Ç–Ω–æ –≤ Buffer
      const editedImageBuffer = Buffer.from(editedImageBase64, 'base64');
      
      console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      regeneratePrompts.set(`${chatId}_edit`, {
        prompt: prompt,
        images: imagesArray.slice(0, imageCount),
        imageId: imageId,
        timestamp: Date.now()
      });
      
      // –°–æ–∑–¥–∞–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const replyMarkup = {
        inline_keyboard: [
          [
            { text: 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é', callback_data: 'regen_edit' }
          ]
        ]
      };
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      const captionText = imageCount === 2 
        ? `‚ú® –ì–æ—Ç–æ–≤–æ! (–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∏–∑ ${imageCount} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)${textResponse ? '\n\n' + textResponse : ''}`
        : `‚ú® –ì–æ—Ç–æ–≤–æ!${textResponse ? '\n\n' + textResponse : ''}`;
      
      await bot.sendPhoto(chatId, editedImageBuffer, {
        caption: captionText,
        reply_markup: replyMarkup
      });
      
      console.log('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    } else {
      console.log('‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ');
      
      if (textResponse) {
        bot.sendMessage(chatId, `‚ÑπÔ∏è Gemini –æ—Ç–≤–µ—Ç–∏–ª:\n\n${textResponse}\n\n‚ö†Ô∏è –ù–æ –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.`);
      } else {
        bot.sendMessage(chatId, '‚ö†Ô∏è Gemini –Ω–µ —Å–º–æ–≥ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n\n‚Ä¢ –ë–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç\n‚Ä¢ –î—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n‚Ä¢ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å');
      }
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:');
    console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
    console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n';
    
    if (error.message) {
      errorMessage += `–î–µ—Ç–∞–ª–∏: ${error.message}`;
    }
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ API
    if (error.message && error.message.includes('API key')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ Gemini –≤ —Ñ–∞–π–ª–µ .env';
    } else if (error.message && error.message.includes('quota')) {
      errorMessage += '\n\nüí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    } else if (error.message && error.message.includes('model')) {
      errorMessage += '\n\nüí° –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ ai.google.dev –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å';
    } else if (error.message && error.message.includes('permission')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞.';
    } else if (error.message && error.message.includes('SAFETY')) {
      errorMessage += '\n\nüí° –ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–º–ø—Ç.';
    }
    
    errorMessage += '\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.';
    
    bot.sendMessage(chatId, errorMessage);
  }
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
async function processImageGeneration(chatId, prompt) {
  try {
    await bot.sendChatAction(chatId, 'upload_photo');
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const selectedModel = imageModels.get(`${chatId}_generate`) || 'gemini-2.5-flash-image';
    
    bot.sendMessage(chatId, `üñºÔ∏è –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ ${selectedModel}...\n‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-30 —Å–µ–∫—É–Ω–¥...`);
    
    console.log('üñºÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    console.log('ü§ñ –ú–æ–¥–µ–ª—å:', selectedModel);
    console.log('üìù –ü—Ä–æ–º–ø—Ç:', prompt);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –º–æ–¥–µ–ª—å Imagen –∏–ª–∏ Gemini
    const isImagenModel = selectedModel.startsWith('imagen-');
    
    let generatedImageBase64 = null;
    let textResponse = '';
    
    if (isImagenModel) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ generateImages –¥–ª—è –º–æ–¥–µ–ª–µ–π Imagen
      console.log('üì∏ –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ generateImages –¥–ª—è Imagen');
      
      const response = await ai.models.generateImages({
        model: selectedModel,
        prompt: prompt,
        config: {
          numberOfImages: 1,
          aspectRatio: '1:1',
          personGeneration: 'allow_adult'
        }
      });
      
      console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Imagen –ø–æ–ª—É—á–µ–Ω');
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
      if (response.generatedImages && response.generatedImages.length > 0) {
        const generatedImage = response.generatedImages[0];
        if (generatedImage.image && generatedImage.image.imageBytes) {
          generatedImageBase64 = generatedImage.image.imageBytes;
          console.log('üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ Imagen');
        }
      }
    } else {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ generateContent –¥–ª—è –º–æ–¥–µ–ª–µ–π Gemini
      console.log('üì∏ –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ generateContent –¥–ª—è Gemini');
      
      const response = await ai.models.generateContent({
        model: selectedModel,
        contents: [
          {
            role: 'user',
            parts: [
              {
                text: prompt
              }
            ]
          }
        ],
        config: {
          temperature: 0.8,
        }
      });
      
      console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Gemini –ø–æ–ª—É—á–µ–Ω');
      
      // –ò—â–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ
      if (response.candidates && response.candidates[0]) {
        const candidate = response.candidates[0];
        if (candidate.content && candidate.content.parts) {
          for (const part of candidate.content.parts) {
            if (part.inlineData && part.inlineData.data) {
              generatedImageBase64 = part.inlineData.data;
              console.log('üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ Gemini');
            }
            if (part.text) {
              textResponse = part.text;
            }
          }
        }
      }
    }
    
    if (generatedImageBase64) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º base64 –æ–±—Ä–∞—Ç–Ω–æ –≤ Buffer
      const generatedImageBuffer = Buffer.from(generatedImageBase64, 'base64');
      
      console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      regeneratePrompts.set(`${chatId}_img`, {
        prompt: prompt,
        timestamp: Date.now()
      });
      
      // –°–æ–∑–¥–∞–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const replyMarkup = {
        inline_keyboard: [
          [
            { text: 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é', callback_data: 'regen_img' }
          ]
        ]
      };
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      await bot.sendPhoto(chatId, generatedImageBuffer, {
        caption: textResponse ? `‚ú® –ì–æ—Ç–æ–≤–æ!\n\n${textResponse}` : '‚ú® –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ!',
        reply_markup: replyMarkup
      });
      
      console.log('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    } else {
      console.log('‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –æ—Ç–≤–µ—Ç–µ');
      
      if (textResponse) {
        bot.sendMessage(chatId, `‚ÑπÔ∏è AI –æ—Ç–≤–µ—Ç–∏–ª:\n\n${textResponse}\n\n‚ö†Ô∏è –ù–æ –Ω–µ –≤–µ—Ä–Ω—É–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.`);
      } else {
        bot.sendMessage(chatId, '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n\n‚Ä¢ –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç\n‚Ä¢ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ\n‚Ä¢ –ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É\n\nüí° –°–æ–≤–µ—Ç: –û–ø–∏—à–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ü–µ–Ω—É, —Å—Ç–∏–ª—å, —Ü–≤–µ—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.');
      }
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:');
    console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
    console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n';
    
    if (error.message) {
      errorMessage += `–î–µ—Ç–∞–ª–∏: ${error.message}`;
    }
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ API
    if (error.message && error.message.includes('API key')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ Gemini –≤ —Ñ–∞–π–ª–µ .env';
    } else if (error.message && error.message.includes('quota')) {
      errorMessage += '\n\nüí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    } else if (error.message && error.message.includes('model')) {
      errorMessage += '\n\nüí° –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ ai.google.dev –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å';
    } else if (error.message && error.message.includes('permission')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞.';
    } else if (error.message && error.message.includes('SAFETY')) {
      errorMessage += '\n\nüí° –ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–º–ø—Ç.';
    }
    
    errorMessage += '\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É.';
    
    bot.sendMessage(chatId, errorMessage);
  }
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
async function processVideoGeneration(chatId, prompt) {
  let tempVideoPath = null;
  let statusMessage = null;
  
  try {
    await bot.sendChatAction(chatId, 'upload_video');
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const selectedModel = videoModels.get(`${chatId}_genvideo`) || 'veo-3.0-fast-generate-001';
    
    statusMessage = await bot.sendMessage(chatId, `üé¨ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ ${selectedModel}...\n‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-60 —Å–µ–∫—É–Ω–¥, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...`);
    
    console.log('üé¨ –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤–∏–¥–µ–æ');
    console.log('ü§ñ –ú–æ–¥–µ–ª—å:', selectedModel);
    console.log('üìù –ü—Ä–æ–º–ø—Ç:', prompt);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Gemini –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
    let operation = await ai.models.generateVideos({
      model: selectedModel, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –º–æ–¥–µ–ª—å
      prompt: prompt,
    });
    
    console.log('‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º polling...');
    
    // Polling –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    let pollCount = 0;
    const maxPolls = 60; // –ú–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç (60 * 10 —Å–µ–∫—É–Ω–¥)
    
    while (!operation.done && pollCount < maxPolls) {
      console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ... (–ø–æ–ø—ã—Ç–∫–∞ ${pollCount + 1}/${maxPolls})`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 3 –ø–æ–ø—ã—Ç–∫–∏
      if (pollCount % 3 === 0 && pollCount > 0) {
        try {
          await bot.editMessageText(
            `üé¨ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ ${selectedModel}...\n‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å: ${pollCount * 10} —Å–µ–∫—É–Ω–¥...`,
            {
              chat_id: chatId,
              message_id: statusMessage.message_id
            }
          );
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        }
      }
      
      await new Promise((resolve) => setTimeout(resolve, 10000)); // –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥
      operation = await ai.operations.getVideosOperation({
        operation: operation,
      });
      pollCount++;
    }
    
    if (!operation.done) {
      console.log('‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ');
      try {
        await bot.editMessageText(
          '‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.',
          {
            chat_id: chatId,
            message_id: statusMessage.message_id
          }
        );
      } catch (e) {
        bot.sendMessage(chatId, '‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.');
      }
      return;
    }
    
    console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ, —Å–∫–∞—á–∏–≤–∞–µ–º...');
    
    // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üìã –ü–æ–ª–Ω—ã–π response:', JSON.stringify(operation.response, null, 2));
    
    try {
      await bot.editMessageText(
        `üé¨ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ! –°–∫–∞—á–∏–≤–∞—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é...`,
        {
          chat_id: chatId,
          message_id: statusMessage.message_id
        }
      );
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ
    if (!operation.response || !operation.response.generatedVideos || operation.response.generatedVideos.length === 0) {
      console.error('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ –≤ –æ—Ç–≤–µ—Ç–µ');
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API');
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ
    const generatedVideo = operation.response.generatedVideos[0];
    
    console.log('üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ:', JSON.stringify({
      hasVideo: !!generatedVideo.video,
      videoUri: generatedVideo.video?.uri,
      videoName: generatedVideo.video?.name,
    }, null, 2));
    
    // –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    tempVideoPath = path.join(process.cwd(), `temp_video_${chatId}_${Date.now()}.mp4`);
    
    console.log('üì• –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ URI –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    if (generatedVideo.video.uri) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ axios
      console.log('üîó –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ URI:', generatedVideo.video.uri);
      const videoResponse = await axios.get(generatedVideo.video.uri, {
        responseType: 'arraybuffer',
        headers: {
          'x-goog-api-key': process.env.GEMINI_API_KEY
        },
        maxContentLength: Infinity,
        maxBodyLength: Infinity
      });
      
      fs.writeFileSync(tempVideoPath, videoResponse.data);
      console.log(`‚úÖ –í–∏–¥–µ–æ —Å–∫–∞—á–∞–Ω–æ —á–µ—Ä–µ–∑ URI, —Ä–∞–∑–º–µ—Ä: ${Math.round(videoResponse.data.length / 1024)} KB`);
    } else {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ SDK
      await ai.files.download({
        file: generatedVideo.video,
        downloadPath: tempVideoPath,
      });
      
      // –ñ–¥–µ–º, –ø–æ–∫–∞ —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø–∏—à–µ—Ç—Å—è
      let fileExists = false;
      let attempts = 0;
      const maxAttempts = 30; // 30 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
      
      while (!fileExists && attempts < maxAttempts) {
        if (fs.existsSync(tempVideoPath)) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –∏–º–µ–µ—Ç —Ä–∞–∑–º–µ—Ä > 0
          const stats = fs.statSync(tempVideoPath);
          if (stats.size > 0) {
            fileExists = true;
            console.log(`‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω —á–µ—Ä–µ–∑ SDK, —Ä–∞–∑–º–µ—Ä: ${Math.round(stats.size / 1024)} KB`);
          } else {
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
          }
        } else {
          await new Promise(resolve => setTimeout(resolve, 1000));
          attempts++;
        }
      }
      
      if (!fileExists) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ —Ñ–∞–π–ª');
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    const stats = fs.statSync(tempVideoPath);
    console.log(`üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${Math.round(stats.size / 1024)} KB (${stats.size} bytes)`);
    
    if (stats.size < 1000) {
      throw new Error(`–í–∏–¥–µ–æ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π: ${stats.size} bytes. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.`);
    }
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    regeneratePrompts.set(`${chatId}_video`, {
      prompt: prompt,
      timestamp: Date.now()
    });
    
    // –°–æ–∑–¥–∞–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const replyMarkup = {
      inline_keyboard: [
        [
          { text: 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é', callback_data: 'regen_video' }
        ]
      ]
    };
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Buffer
    const videoBuffer = fs.readFileSync(tempVideoPath);
    await bot.sendVideo(chatId, videoBuffer, {
      caption: `‚ú® –í–∏–¥–µ–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ ${selectedModel}!`,
      contentType: 'video/mp4',
      reply_markup: replyMarkup
    });
    
    console.log('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try {
      await bot.deleteMessage(chatId, statusMessage.message_id);
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ:');
    console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
    console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å operation, –ª–æ–≥–∏—Ä—É–µ–º –µ–≥–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if (typeof operation !== 'undefined') {
      console.error('üìã Operation state:', JSON.stringify({
        done: operation?.done,
        hasResponse: !!operation?.response,
        responseKeys: operation?.response ? Object.keys(operation.response) : []
      }, null, 2));
    }
    
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ.\n\n';
    
    if (error.message) {
      errorMessage += `–î–µ—Ç–∞–ª–∏: ${error.message}`;
    }
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ API
    if (error.message && error.message.includes('API key')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ Gemini –≤ —Ñ–∞–π–ª–µ .env';
    } else if (error.message && error.message.includes('quota')) {
      errorMessage += '\n\nüí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    } else if (error.message && error.message.includes('model')) {
      errorMessage += '\n\nüí° –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ ai.google.dev';
    } else if (error.message && error.message.includes('permission')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞.';
    } else if (error.message && error.message.includes('SAFETY')) {
      errorMessage += '\n\nüí° –ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–º–ø—Ç.';
    } else if (error.message && error.message.includes('–ø–æ–ª—É—á–∏—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ')) {
      errorMessage += '\n\nüí° API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –î—Ä—É–≥—É—é –º–æ–¥–µ–ª—å\n‚Ä¢ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç\n‚Ä¢ –ü–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ';
    }
    
    errorMessage += '\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É.';
    
    bot.sendMessage(chatId, errorMessage);
  } finally {
    // –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω
    if (tempVideoPath && fs.existsSync(tempVideoPath)) {
      try {
        fs.unlinkSync(tempVideoPath);
        console.log('üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω');
      } catch (e) {
        console.error('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:', e.message);
      }
    }
  }
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–æ–º–ø—Ç–æ–º
async function processVideoGenerationFromImage(chatId, base64Image, prompt, imageId) {
  let tempVideoPath = null;
  let statusMessage = null;
  
  try {
    await bot.sendChatAction(chatId, 'upload_video');
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const selectedModel = videoModels.get(`${chatId}_genvideofrompicture`) || 'veo-3.0-fast-generate-001';
    
    statusMessage = await bot.sendMessage(chatId, `üé• –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ ${selectedModel}...\n‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-60 —Å–µ–∫—É–Ω–¥, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...`);
    
    console.log('üé• –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    console.log('ü§ñ –ú–æ–¥–µ–ª—å:', selectedModel);
    console.log('üìù –ü—Ä–æ–º–ø—Ç:', prompt);
    console.log('üñºÔ∏è –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (base64):', base64Image.length, '—Å–∏–º–≤–æ–ª–æ–≤');
    
    // SDK –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –¥–ª—è Veo, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π REST API
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:predictLongRunning`;
    
    const requestBody = {
      instances: [{
        prompt: prompt,
        image: {
          bytesBase64Encoded: base64Image,
          mimeType: 'image/jpeg'
        }
      }]
    };
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ REST API...');
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ REST API
    const response = await axios.post(apiUrl, requestBody, {
      headers: {
        'x-goog-api-key': process.env.GEMINI_API_KEY,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –ø–æ–ª—É—á–µ–Ω operation:', response.data.name);
    
    // –°–æ–∑–¥–∞–µ–º operation –æ–±—ä–µ–∫—Ç –¥–ª—è polling
    let operation = {
      name: response.data.name,
      done: false
    };
    
    console.log('‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º polling...');
    
    // Polling –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ REST API
    let pollCount = 0;
    const maxPolls = 60; // –ú–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç (60 * 10 —Å–µ–∫—É–Ω–¥)
    const operationUrl = `https://generativelanguage.googleapis.com/v1beta/${operation.name}`;
    
    while (!operation.done && pollCount < maxPolls) {
      console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ... (–ø–æ–ø—ã—Ç–∫–∞ ${pollCount + 1}/${maxPolls})`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 3 –ø–æ–ø—ã—Ç–∫–∏
      if (pollCount % 3 === 0 && pollCount > 0) {
        try {
          await bot.editMessageText(
            `üé• –ì–µ–Ω–µ—Ä–∏—Ä—É—é –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...\n‚è≥ –ü—Ä–æ–≥—Ä–µ—Å—Å: ${pollCount * 10} —Å–µ–∫—É–Ω–¥...`,
            {
              chat_id: chatId,
              message_id: statusMessage.message_id
            }
          );
        } catch (e) {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        }
      }
      
      await new Promise((resolve) => setTimeout(resolve, 10000)); // –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ REST API
      const statusResponse = await axios.get(operationUrl, {
        headers: {
          'x-goog-api-key': process.env.GEMINI_API_KEY
        }
      });
      
      operation = statusResponse.data;
      pollCount++;
    }
    
    if (!operation.done) {
      console.log('‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ');
      try {
        await bot.editMessageText(
          '‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.',
          {
            chat_id: chatId,
            message_id: statusMessage.message_id
          }
        );
      } catch (e) {
        bot.sendMessage(chatId, '‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ.');
      }
      return;
    }
    
    console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ, —Å–∫–∞—á–∏–≤–∞–µ–º...');
    
    try {
      await bot.editMessageText(
        'üé• –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ! –°–∫–∞—á–∏–≤–∞—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é...',
        {
          chat_id: chatId,
          message_id: statusMessage.message_id
        }
      );
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∏–∑ REST API –æ—Ç–≤–µ—Ç–∞
    // –§–æ—Ä–º–∞—Ç: operation.response.generateVideoResponse.generatedSamples[0]
    const generateVideoResponse = operation.response?.generateVideoResponse;
    
    if (!generateVideoResponse || !generateVideoResponse.generatedSamples || generateVideoResponse.generatedSamples.length === 0) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API');
    }
    
    const generatedSample = generateVideoResponse.generatedSamples[0];
    const videoUri = generatedSample.video?.uri;
    
    console.log('üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ:', JSON.stringify({
      hasVideo: !!generatedSample.video,
      videoUri: videoUri,
    }, null, 2));
    
    if (!videoUri) {
      throw new Error('–í–∏–¥–µ–æ URI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—Ç–≤–µ—Ç–µ');
    }
    
    // –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    tempVideoPath = path.join(process.cwd(), `temp_video_from_img_${chatId}_${Date.now()}.mp4`);
    
    console.log('üì• –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ...');
    console.log('üîó –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ URI:', videoUri);
    
    // –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –Ω–∞–ø—Ä—è–º—É—é –ø–æ URI
    const videoResponse = await axios.get(videoUri, {
      responseType: 'arraybuffer',
      headers: {
        'x-goog-api-key': process.env.GEMINI_API_KEY
      },
      maxContentLength: Infinity,
      maxBodyLength: Infinity
    });
    
    fs.writeFileSync(tempVideoPath, videoResponse.data);
    console.log(`‚úÖ –í–∏–¥–µ–æ —Å–∫–∞—á–∞–Ω–æ, —Ä–∞–∑–º–µ—Ä: ${Math.round(videoResponse.data.length / 1024)} KB`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    const stats = fs.statSync(tempVideoPath);
    console.log(`üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${Math.round(stats.size / 1024)} KB (${stats.size} bytes)`);
    
    if (stats.size < 1000) {
      throw new Error(`–í–∏–¥–µ–æ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π: ${stats.size} bytes. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.`);
    }
    
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    regeneratePrompts.set(`${chatId}_videofromimg`, {
      prompt: prompt,
      image: base64Image,
      imageId: imageId,
      timestamp: Date.now()
    });
    
    // –°–æ–∑–¥–∞–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const replyMarkup = {
      inline_keyboard: [
        [
          { text: 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é', callback_data: 'regen_videofromimg' }
        ]
      ]
    };
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Buffer
    const videoBuffer = fs.readFileSync(tempVideoPath);
    await bot.sendVideo(chatId, videoBuffer, {
      caption: `‚ú® –í–∏–¥–µ–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ ${selectedModel}!`,
      contentType: 'video/mp4',
      reply_markup: replyMarkup
    });
    
    console.log('‚úÖ –í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try {
      await bot.deleteMessage(chatId, statusMessage.message_id);
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:');
    console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.constructor.name);
    console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
    console.error('–ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞:', error);
    
    let errorMessage = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–¥–µ–æ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n';
    
    if (error.message) {
      errorMessage += `–î–µ—Ç–∞–ª–∏: ${error.message}`;
    }
    
    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ API
    if (error.message && error.message.includes('API key')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞ Gemini –≤ —Ñ–∞–π–ª–µ .env';
    } else if (error.message && error.message.includes('quota')) {
      errorMessage += '\n\nüí° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    } else if (error.message && error.message.includes('model')) {
      errorMessage += '\n\nüí° –ú–æ–¥–µ–ª—å Veo 3 –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞ ai.google.dev';
    } else if (error.message && error.message.includes('permission')) {
      errorMessage += '\n\nüí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞.';
    } else if (error.message && error.message.includes('SAFETY')) {
      errorMessage += '\n\nüí° –ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –ø—Ä–æ–º–ø—Ç.';
    }
    
    errorMessage += '\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.';
    
    bot.sendMessage(chatId, errorMessage);
  } finally {
    // –í—Å–µ–≥–¥–∞ —É–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω
    if (tempVideoPath && fs.existsSync(tempVideoPath)) {
      try {
        fs.unlinkSync(tempVideoPath);
        console.log('üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω');
      } catch (e) {
        console.error('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:', e.message);
      }
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ polling
bot.on('polling_error', (error) => {
  console.error('–û—à–∏–±–∫–∞ polling:', error.code, error.message);
});

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–µ—Å—Å–∏–π (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)
setInterval(() => {
  const now = Date.now();
  const timeout = 30 * 60 * 1000; // 30 –º–∏–Ω—É—Ç
  
  // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–µ—Å—Å–∏–π
  for (const [chatId, session] of userSessions.entries()) {
    if (now - session.timestamp > timeout) {
      userSessions.delete(chatId);
      imageStorage.delete(chatId); // –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
    }
  }
  
  // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç-—Å–µ—Å—Å–∏–π
  for (const [chatId, chatSession] of chatSessions.entries()) {
    if (now - chatSession.timestamp > timeout) {
      chatSessions.delete(chatId);
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —á–∞—Ç-—Å–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
    }
  }
  
  // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  const imageTimeout = 60 * 60 * 1000; // 1 —á–∞—Å
  for (const chatId of imageStorage.keys()) {
    const session = userSessions.get(chatId);
    if (!session || (now - session.timestamp > imageTimeout)) {
      imageStorage.delete(chatId);
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);
    }
  }
  
  // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const promptTimeout = 60 * 60 * 1000; // 1 —á–∞—Å
  for (const [key, data] of regeneratePrompts.entries()) {
    if (now - data.timestamp > promptTimeout) {
      regeneratePrompts.delete(key);
      console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${key}`);
    }
  }
}, 30 * 60 * 1000);


